function Label(a){a=a||{},this.text=a.text||"Undefined Label Text",this.font=a.font||"1em Arial",this.pos={x:0,y:0},this.pos.x=a.x||0,this.pos.y=a.y||0,this.pos=a.pos||{x:this.pos.x,y:this.pos.y},this.color=a.color||"#fff",this.x=this.pos.x,this.y=this.pos.y,this.live=!0,this.visible=!0}function Button(a){Jest.Sprite.call(this,a),a&&(a.clicked&&(this.clicked=a.clicked),a.hover&&(this.hover=a.hover)),this.clickable=!0}function Cursor(a){Jest.Sprite.call(this,a)}(function(a,b,c,d,e,f){function k(a){var b,c=a.length,e=this,f=0,g=e.i=e.j=0,h=e.S=[];c||(a=[c++]);while(f<d)h[f]=f++;for(f=0;f<d;f++)h[f]=h[g=j&g+a[f%c]+(b=h[f])],h[g]=b;(e.g=function(a){var b,c=0,f=e.i,g=e.j,h=e.S;while(a--)b=h[f=j&f+1],c=c*d+h[j&(h[f]=h[g=j&g+b])+(h[g]=b)];return e.i=f,e.j=g,c})(d)}function l(a,b){var c=[],d=(typeof a)[0],e;if(b&&d=="o")for(e in a)try{c.push(l(a[e],b-1))}catch(f){}return c.length?c:d=="s"?a:a+"\0"}function m(a,b){var c=a+"",d,e=0;while(e<c.length)b[j&e]=j&(d^=b[j&e]*19)+c.charCodeAt(e++);return o(b)}function n(c){try{return a.crypto.getRandomValues(c=new Uint8Array(d)),o(c)}catch(e){return[+(new Date),a,a.navigator.plugins,a.screen,o(b)]}}function o(a){return String.fromCharCode.apply(0,a)}var g=c.pow(d,e),h=c.pow(2,f),i=h*2,j=d-1;c.seedrandom=function(a,f){var j=[],p=m(l(f?[a,o(b)]:0 in arguments?a:n(),3),j),q=new k(j);return m(o(q.S),b),c.random=function(){var a=q.g(e),b=g,c=0;while(a<h)a=(a+c)*d,b*=d,c=q.g(1);while(a>=i)a/=2,b/=2,c>>>=1;return(a+c)/b},p},m(c.random(),b)})(this,[],Math,256,6,52),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){window.setTimeout(a,1e3/60)}}();var Game={},Jest=function(a){a=a||{},this.renderCanvas=a.canvas||"playCanvas",this.width=a.width||320,this.height=a.height||240,this.frameRate=a.frameRate||Math.ceil(1e3/60),this.showFrameRate=a.showFrameRate||!1,this.stateName=a.stateName||"0",this.states=[],this.currentState={},this.renderer={},this.renderList=[],this.entities=[],this.intervalId={},this.lastTime=(new Date).getTime(),this.accTime=0,this.timeStep=1,this.bounds={x:0,y:0,width:this.width,height:this.height},this.frameRateLabel={},this.resourceManager=new Jest.ResourceManager,this.hitEntities=[],this.particleCount=0,Jest.frameRate=this.frameRate,Jest.bounds=this.bounds,Jest.particleCount=this.particleCount,Jest.utilities=this.utilities,Jest.states=this.states,Jest.currentState=this.currentState};Jest.prototype={load:function(){this.loaded(this)},loaded:function(a){var b=this;return this.resourceManager.loadingComplete?(a.init(),!0):(setTimeout(function(){b.loaded(a)},100),!1)},init:function(){var a=this;this.renderCanvas=document.getElementById(this.renderCanvas),this.renderCanvas===null&&(this.renderCanvas=document.createElement("canvas")),this.renderCanvas.addEventListener("click",function(b){a.clicked(b,a)},!1),this.renderCanvas.addEventListener("mousemove",function(b){a.mouseMove(b,a)},!1),this.renderCanvas.addEventListener("mousedown",function(b){a.mouseDown(b,a)},!1),this.renderCanvas.addEventListener("mouseup",function(b){a.mouseUp(b,a)},!1),this.renderCanvas.addEventListener("contextmenu",function(a){a.preventDefault()},!1),this.renderCanvas.addEventListener("mousewheel",function(b){a.mouseWheel(b,a)},!1),this.renderCanvas.addEventListener("DOMMouseScroll",function(b){a.mouseWheel(b,a)},!1),this.renderCanvas.width=this.width,this.renderCanvas.height=this.height,this.renderer=new Jest.Renderer(this.renderCanvas),this.addState(this.stateName),this.switchState({id:0}),this.showFrameRate&&(this.frameRateLabel=new Label({text:" ",x:0,y:30,z:1,font:"14pt arial bold"}),this.addEntity(this.frameRateLabel)),this.mouseX=0,this.mouseY=0,this.moused=!1,this.leftDown=!1,this.rightDown=!1,this.midDown=!1,this.update()},update:function(){var a=(new Date).getTime(),b=this.update;this.deltaTime=a-this.lastTime,this.lastTime=a,this.accTime+=this.deltaTime,this.accTime>60&&(this.accTime=0);while(this.accTime>this.timeStep){this.accTime-=this.timeStep;var c=this.entities,d=this.entities.length;while(d--){var e=c[d];e!==undefined&&(e.live?e.update(this.timeStep/100):this.removeEntity(e))}}this.renderer.redraw(),this.frameRateLabel.text=Math.round(1e3/this.deltaTime)+" fps",this.currentFrameRate=Math.round(1e3/this.deltaTime);var f=this;requestAnimFrame(function(){f.update()})},clicked:function(a,b){this.cX=0,this.cY=0,a.pageX||a.pageY?(this.cX=a.pageX,this.cY=a.pageY):(this.cX=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,this.cY=a.clientY+document.body.scrollTop+document.documentElement.scrollTop),this.cX-=b.renderCanvas.offsetLeft,this.cY-=b.renderCanvas.offsetTop;var c=b.entities.length,d=b.entities;while(c--){var e=d[c];e.clickable&&e.pos&&e.origin&&this.cX>e.pos.x-e.origin.x&&this.cX<e.pos.x-e.origin.x+e.width&&this.cY>e.pos.y-e.origin.y&&this.cY<e.pos.y-e.origin.y+e.height&&e.clicked()}return{clickX:this.cX,clickY:this.cY}},mouseMove:function(a,b){a.pageX||a.pageY?(b.mouseX=a.pageX-b.renderCanvas.offsetLeft,b.mouseY=a.pageY-b.renderCanvas.offsetTop):(b.mouseX=a.clientX+document.body.scrollLeft-document.body.clientLeft-b.renderCanvas.offsetLeft,b.mouseY=a.clientY+document.body.scrollTop-document.body.clientTop-b.renderCanvas.offsetTop)},mouseDown:function(a,b){b.moused=!0;if("which"in a)switch(a.which){case 1:b.leftDown=!0;break;case 2:b.midDown=!0;break;case 3:b.rightDown=!0}},mouseUp:function(a,b){b.moused=!1,b.leftDown=!1,b.midDown=!1,b.rightDown=!1},mouseWheel:function(a,b){var c=0;return"wheelDelta"in a?Math.abs(a.wheelDelta)-a.wheelDelta===0?c=-1:c=1:a.detail&&(Math.abs(a.detail)-a.detail===0?c=1:c=-1),c},addEntity:function(a,b,c){"live"in a||(a.live=!0),this.renderFalse=b;if(c){var d=this.getState(c);d&&(d.entityList.push(a),a.state=d)}else this.entities.push(a),a.state=this.currentState;b||this.renderer.addToRenderer(a)},removeEntity:function(a,b){var c=this.entities,d=c.length;if(b){var e=this.getState(b);e&&(c=e.entityList,d=c.length)}var f=c.indexOf(a);typeof a.kill!="undefined"&&a.kill(),c.splice(f,1),this.renderer.removeFromRenderer(a),delete a},addState:function(a){var b={};a?b.name=a:b.name=this.states.length,b.id=this.states.length,b.renderList=[],b.entityList=[],this.states.push(b)},getState:function(a){var b=!1;if("id"in a)b=this.states[a.id];else if("name"in a){var c=a.name;for(var d=0,e=this.states.length;d<e;d++)if(this.states[d].name===c){b=this.states[d];break}}return b},switchState:function(a){var b=this.getState(a);b&&(a.exitTransition&&!a.exitComplete?(a.exitComplete=!0,Game.addEntity(new Jest.Transition(a.exitTransition,function(){Game.switchState(a)}))):(this.currentState=b,this.renderer.renderList=this.currentState.renderList,this.entities=this.currentState.entityList,a.enterTransition&&Game.addEntity(new Jest.Transition(a.enterTransition))))},checkHit:function(a,b){var c=this.entities.length,d=this.entities;this.hitEntities=[];for(var e=0,f=this.entities.length;e<f;e++){var g=d[e];g.live&&g.clickable&&a>g.x&&a<g.x+g.width&&b>g.y&&b<g.y+g.height&&this.hitEntities.push(g)}}},function(){function a(b,c,d){this.x=b,this.y=c,this.z=d,copy=function(a){this.x=a.x,this.y=a.y,this.z=a.z},add=function(a){this.x+=a.x,this.y+=a.y,this.z+=a.z},sub=function(a){this.x-=a.x,this.y-=a.y,this.z-=a.z},cross=function(a){this.tx=this.x,this.ty=this.y,this.tz=this.z,this.x=this.ty*a.z-this.tz*a.y,this.y=this.tz*a.x-this.tx*a.z,this.z=this.tx*a.y-this.ty*a.x},multiply=function(a){this.x*=a,this.y*=a,this.z*=a},distanceTo=function(a){return this.dx=this.x-a.x,this.dy=this.y-a.y,this.dz=this.z-a.z,Math.sqrt(this.dx*this.dx+this.dy*this.dy+this.dz*this.dz)},distanceToSquared=function(a){return this.dx=this.x-a.x,this.dy=this.y-a.y,this.dz=this.z-a.z,this.dx*this.dx+this.dy*this.dy+this.dz*this.dz},length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthSq=function(){return this.x*this.x+this.y*this.y+this.z*this.z},negate=function(){this.x=-this.x,this.y=-this.y,this.z=-this.z},dot=function(a){return this.x*a.x+this.y*a.y+this.z*a.z},clone=function(){return new a(this.x,this.y,this.z)},toString=function(){return"("+this.x+", "+this.y+", "+this.z+")"}}this.Vector=a,a.prototype={add:function(b,c){return new a(b.x+c.x,b.y+c.y,b.z+c.z)},sub:function(b,c){return new a(b.x-c.x,b.y-c.y,b.z-c.z)},negate:function(){this.x=-this.x,this.y=-this.y,this.z=-this.z},multiply:function(b,c){return new a(b.x*c,b.y*c,b.z*c)},cross:function(b,c){return new a(b.y*c.z-b.z*c.y,b.z*c.x-b.x*c.z,b.x*c.y-b.y*c.x)},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z},distance:function(a,b){var c=a.x-b.x,d=a.y-b.y,e=a.z-b.z;return Math.sqrt(c*c+d*d+e*e)},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},mulScale:function(b,c){return new a(this.x*c,this.y*c,this.z*c)},normalize:function(){return this.length()>0?this.ool=1/this.length():this.ool=0,this.x*=this.ool,this.y*=this.ool,this.z*=this.ool,this}}}(),Object.merge=function(){return[].reduce.call(arguments,function(a,b){return Object.keys(b).forEach(function(c){a[c]=b[c]}),a},{})},Jest.prototype.Utilities={getRandomRange:function(a,b){return Math.floor(Math.random()*(b-a+1))+a},fGetRandomRange:function(a,b){return Math.random()*(b-a)+a},getDistance:function(a,b){return Math.sqrt((b.x-a.x)*(b.x-a.x)+(b.y-a.y)*(b.y-a.y))},getAngle:function(a,b){var c=b.x-a.x,d=b.y-a.y,e=Math.atan2(d,c),f=e/Math.PI*180;return f},getRad:function(a,b){var c=b.x-a.x,d=b.y-a.y,e=Math.atan2(d,c);return e},mouse:function(a){return a.pageX||a.pageY?{x:a.pageX,y:a.pageY}:{x:a.clientX+document.body.scrollLeft-document.body.clientLeft,y:a.clientY+document.body.scrollTop-document.body.clientTop}},getGradColor:function(a,c,d,e){var f=-(e-d)/6,h=a.r+f*(c.r-a.r);return b=a.b+f*(c.b-a.b),g=a.g+f*(c.g-a.g),"rgb("+Math.floor(Math.min(255,Math.max(0,h)))+","+Math.floor(Math.min(255,Math.max(0,g)))+","+Math.floor(Math.min(255,Math.max(0,b)))+")"},preCalcRotation:function(a,b,c,d,e){if(a.nodeType===1){var f=a;a={},a.source=f}var g=document.createElement("canvas"),h=g.getContext("2d"),i=document.createElement("canvas"),j=i.getContext("2d"),k=a.source.width/c,l=360/b;startAngle=0,e&&(startAngle=e),g.width=a.source.width,g.height=Math.ceil(d*360/l),i.width=c,i.height=d;for(var m=0;m<b;m++)for(var n=0;n<k;n++)j.clearRect(0,0,c,d),j.save(),j.translate(i.width/2,i.height/2),j.rotate((startAngle+l*m)*Math.PI/180),j.drawImage(a.source,n*c,0,c,d,-c/2,-d/2,c,d),j.restore(),h.drawImage(i,0,0,c,d,n*c,m*d,c,d);return a.source=g,g},colorize:function(a,b){var c=document.createElement("canvas"),d=c.getContext("2d");c.width=a.source.width,c.height=a.source.height,d.drawImage(a.source,0,0);var e=d.getImageData(0,0,c.width,c.height),f=e.data,g=b.h,h=b.s,i=b.v;for(var j=0,k=f.length;j<k;j+=4){b=this.rgbhsv({r:f[j],g:f[j+1],b:f[j+2]}),b.h+=g,b.h<0?b.h=0:b.h>360&&(b.h=360),b.s+=h,b.v+=i;var l=this.hsvrgb(b);f[j]=l.r,f[j+1]=l.g,f[j+2]=l.b}return d.putImageData(e,0,0),c.toDataURL()},rgbhsv:function(a){var b=a.r,c=a.g,d=a.b,e=Math.max(b,c,d),f=Math.min(b,c,d),g=0,h=0,i=0;return e==f?g=0:e==b?g=60*((c-d)/(e-f))%360:e==c?g=60*((d-b)/(e-f))+120:e==d&&(g=60*((b-c)/(e-f))+240),i=e,e===0?h=0:h=1-f/e,{h:g,s:h,v:i}},hsvrgb:function(a){var b=a.h,c=a.s,d=a.v,e={r:0,g:0,b:0},f=Math.floor(b/60)%6,g=b/60-Math.floor(b/60),h=d*(1-c),i=d*(1-g*c),j=d*(1-(1-g)*c);switch(f){case 0:e.r=d,e.g=j,e.b=h;break;case 1:e.r=i,e.g=d,e.b=h;break;case 2:e.r=h,e.g=d,e.b=j;break;case 3:e.r=h,e.g=i,e.b=d;break;case 4:e.r=j,e.g=h,e.b=d;break;case 5:e.r=d,e.g=h,e.b=i}return e}},Jest.ResourceManager=function(){this.resources=[],this.loaded=0,this.loadingComplete=!0},Jest.ResourceManager.prototype={add:function(a,b,c){var d={path:a,type:b,name:c};a.src&&(d.path=a.src),this.loadingComplete=!1,c===undefined&&(c="");if(b==1||b=="img"||b===null)a.nodeType===1?d.source=a:d.source=new Image,this.resources.push({resource:d,name:c}),d.source.onload=function(a,b){d.loaded=!0,a.loadImg(a,b)}(this,d),a.nodeType===1?d.source.src=a.src:d.source.src=a;else if(b==2||b=="audio")d.source=new Audio,this.resources.push({resource:d,name:c}),this.loadAudio(d),d.source.src=a;return d},loadImg:function(a,b){b.source.complete&&b.source.width?(a.loaded++,a.loaded===a.resources.length&&(a.loadingComplete=!0)):setTimeout(function(){a.loadImg(a,b)},10)},loadAudio:function(a,b){clearTimeout(b),b=0;var c=this;a.source.readyState>0?(this.loaded++,this.loaded===this.resources.length&&(this.loadingComplete=!0)):b=setTimeout(function(){c.loadAudio(a,b)},100)},getResource:function(a){var b=this.resources;for(var c=0,d=b.length;c<d;c++)if(b[c].name==a)return b[c].resource}},this.Label=Label,Label.prototype={update:function(a){},render:function(a){a.fillStyle=this.color,a.font=this.font,a.fillText(this.text,this.pos.x,this.pos.y)}},Jest.Renderer=function(a){this.renderList=[],this.canvas=a,this.context=this.canvas.getContext("2d"),this.width=this.canvas.width,this.height=this.canvas.height},Jest.Renderer.prototype={redraw:function(){this.context.clearRect(0,0,this.width,this.height),this.renderList.sort(function(a,b){return a.bg&&b.bg?b.bgIndex-a.bgIndex:a.ui&&b.ui?b.uiIndex-a.uiIndex:a.bg||b.ui?1:b.bg||a.ui?-1:a.pos&&b.pos?b.pos.z-a.pos.z:0});var a=this.renderList.length;while(a--){var b=this.renderList[a];b.visible&&b.render(this.context)}},addToRenderer:function(a){this.renderList.push(a)},removeFromRenderer:function(a){var b=this.renderList,c=b.indexOf(a);c!==-1&&b.splice(b.indexOf(a),1)}},Jest.Sprite=function(a){a=a||{},this.width=a.width||32,this.height=a.height||32,this.pos=a.pos||{x:0,y:0,z:0};if(a.x&&a.y){var b=0;a.z&&(b=a.z),this.pos=new Vector(a.x,a.y,b)}else a.pos?this.pos=a.pos:this.pos=new Vector(0,0,0);this.origin=a.origin||{x:0,y:0,z:0};if(a.ox&&a.oy){var c=0;a.oz&&(c=a.oz),this.origin=new Vector(a.ox,a.oy,c)}else a.origin?this.origin=a.origin:this.origin=new Vector(0,0,0);this.vel=a.vel||{x:0,y:0,z:0};if(a.vx&&a.vy){var d=0;a.vz&&(d=a.vz),this.vel=new Vector(a.vx,a.vy,d)}else a.vel?this.vel=a.vel:this.vel=new Vector(0,0,0);this.startX=a.startX||0,this.startY=a.startY||0,this.tileable=a.tileable||!1,this.tileable&&(this.endX=a.endX||this.width,this.endY=a.endY||this.height),a.resource===undefined?(this.shape=!0,this.resource={}):(this.shape=!1,this.resource=a.resource),this.angle=a.angle||0,this.thrust=a.thrust||0,this.color=a.color||{r:255,g:255,b:255},this.alpha=255,this.clickable=a.clickable||!1,a.list&&a.list.length!="undefined"?(this.list=a.list,this.list.push(this)):this.list=[],this.visible=!0,this.animations=[],this.isAnimating=!1,this.lastAnim=0,this.animSpeed=0,this.x=this.pos.x,this.y=this.pos.y,this.live=!0},Jest.Sprite.prototype={update:function(a){this.isAnimating&&(new Date).getTime()>this.lastAnim+this.animSpeed&&(this.lastAnim=(new Date).getTime(),this.startX=this.width*this.curAnimation[this.frame],this.frame++,this.frame>this.curAnimation.length-1&&(this.animType!==1?this.isAnimating=!1:this.frame=0))},addAnimation:function(a,b){var c={name:b,frames:a};this.animations.push(c)},playAnimation:function(a,b,c){for(var d=0,e=this.animations.length;d<e;d++){var f=this.animations[d];f.name===a&&(this.curAnimation=f.frames,this.animSpeed=b,typeof c=="undefined"?this.animType=0:this.animType=c,this.frame=0,this.isAnimating=!0)}},checkCollision:function(a,b){},changeFrame:function(a){this.startX=a*this.width},kill:function(){if(this.list.length>0){var a=this.list.length,b=this.list,c=b.indexOf(this);c&&b.splice(c,1)}},render:function(a){a.save();if(!this.shape){var b=.5+(this.pos.x-this.origin.x)<<0,c=.5+(this.pos.y-this.origin.y)<<0;a.drawImage(this.resource.source,this.startX,this.startY,this.width,this.height,b,c,this.width,this.height)}else{var d=this.color;a.fillStyle="rgba("+d.r+","+d.g+","+d.b+","+this.alpha+")",a.fillRect(this.pos.x-this.origin.x,this.pos.y-this.origin.y,this.width,this.height)}a.restore()},clicked:function(){}},Jest.Emitter=function(a){this.live=!0,this.particleGroups=[],this.lastUpdate=(new Date).getTime(),this.startTime=(new Date).getTime(),a=a||{},this.width=a.width||Jest.bounds.width,this.height=a.height||Jest.bounds.height,this.pos=a.pos||{x:0,y:0,z:0},this.particles=[],Game.addEntity(this,!0)},Jest.Emitter.prototype={getParticles:function(){return this.particles},addGroup:function(a){a.startTime=(new Date).getTime(),a.lastUpdate=(new Date).getTime(),typeof a.delay=="undefined"&&(a.delay=0),this.particleGroups.push(a)},removeGroup:function(a){var b=this.particleGroups.length;if(typeOf(a)=="String"){while(b--)if(a===this.particleGroups[b].name){this.particleGroups.splice(b,1);return}}else while(b--)if(a===this.particleGroups[b]){this.particleGroups.splice(b,1);return}return!1},getGroup:function(a){var b=this.particleGroups.length;if(typeOf(a)=="String"){while(b--)if(a===this.particleGroups[b].name)return this.particleGroups[b]}else while(b--)if(a===this.particleGroups[b])return this.particleGroups[b];return!1},kill:function(){this.particleGroups=[]},update:function(a){this.lastUpdate=(new Date).getTime();var b=this.particleGroups,c=Game.Utilities,d=b.length;while(d--)if(this.lastUpdate-b[d].lastUpdate>=1e3/b[d].rate&&this.lastUpdate>b[d].startTime+b[d].delay&&Game.currentFrameRate>30){b[d].lastUpdate=this.lastUpdate;if(this.lastUpdate-this.startTime<b[d].duration||b[d].duration===-1){b[d].oneShot?p=b[d].rate:p=1;while(p--){b[d].x=this.pos.x,b[d].y=this.pos.y,b[d].z=this.pos.z;var e=b[d].thrustRange,f=b[d].angleRange;typeof e!="undefined"&&(typeof e.max!="undefined"&&typeof e.min!="undefined"?b[d].thrust=c.getRandomRange(e.min,e.max):typeof e.max!="undefined"&&(b[d].thrust=c.getRandomRange(0,e.max))),typeof f!="undefined"&&(typeof f.max!="undefined"&&typeof f.min!="undefined"?b[d].angle=c.fGetRandomRange(f.min,f.max):typeof f.max!="undefined"&&(b[d].angle=c.fGetRandomRange(0,f.max))),b[d].list=this.particles;var g=new Jest.Particle(b[d]);this.particles.push(g),Game.addEntity(g)}}else this.particleGroups.splice(d,1)}}},Jest.Particle=function(a){Jest.Sprite.call(this,a),Jest.particleCount++,this.startLife=(new Date).getTime(),this.curStep=0,a=a||{},this.lifeTime=a.lifeTime!==undefined?a.lifeTime:1e3,this.delay=a.delay||0,this.size=a.size||1,this.width=this.height=this.size,this.startSize=a.startSize||this.size,this.endSize=a.endSize!==undefined?a.endSize:this.size,this.thrust=a.thrust||0,this.gravity=a.gravity||0,this.angle=a.angle||0,this.angleChange=a.angleChange||0,this.alignToAngle=a.alignToAngle||!1,this.drawAngle=a.drawAngle||0,this.drawAngleChange=a.drawAngleChange||0,this.startColor=a.startColor||this.color,this.endColor=a.endColor||this.color,this.startAlpha=a.startAlpha!==undefined?a.startAlpha:1,this.endAlpha=a.endAlpha!==undefined?a.endAlpha:1,this.blend=a.blend||!1,this.origin.y=this.height/2,this.origin.x=this.width/2,this.endLife=this.startLife+this.lifeTime,this.colors=[];if(this.endColor!==this.startColor)for(var b=Math.ceil(this.lifeTime/Jest.frameRate)+1;b>-1;b--)this.colors.push(this.colorFade(this.startColor,this.endColor,this.lifeTime,b*Jest.frameRate))},Jest.Particle.prototype=new Jest.Sprite,Jest.Particle.prototype.update=function(a){this.curStep=this.endLife-(new Date).getTime(),this.vel.x=Math.cos(this.angle*Math.PI/180)*this.thrust*a,this.vel.y=(Math.sin(this.angle*Math.PI/180)*this.thrust+this.gravity*(this.lifeTime-this.curStep)*a)*a,this.pos.x+=this.vel.x,this.pos.y+=this.vel.y;if(this.pos.y<0||this.pos.y>Jest.bounds.y+Jest.bounds.height)this.live=!1,Jest.particleCount--;(new Date).getTime()>this.endLife&&(this.live=!1,Jest.particleCount--),this.endAlpha!==this.startAlpha&&(this.endAlpha>this.startAlpha?this.alpha=(this.startAlpha-this.endAlpha)/this.lifeTime*this.curStep:this.alpha=this.endAlpha+(this.startAlpha-this.endAlpha)/this.lifeTime*this.curStep),this.endColor!==this.startColor&&(this.color=this.colors[Math.ceil((this.lifeTime-this.curStep)/Jest.frameRate)]);if(this.endSize!==this.size){var b=0;this.endSize<this.startSize?(b=(this.startSize-this.endSize)/this.lifeTime*this.curStep,this.scale={x:-b,y:-b}):(b=this.endSize+(this.startSize-this.endSize)/this.lifeTime*this.curStep,this.scale={x:-b,y:-b})}this.angleChange&&(this.angle+=this.angleChange*a),this.drawAngleChange&&(this.drawAngle+=this.drawAngleChange*a),this.alignToAngle&&(this.drawAngle=this.angle)},Jest.Particle.prototype.render=function(a){a.save();var b=this.scale||{x:0,y:0},c=this.pos.x,d=this.pos.y,e=this.origin.x,f=this.origin.y,g=this.width,h=this.height,i=this.drawAngle*Math.PI/180;this.blend&&(a.globalCompositeOperation="lighter");if(!this.shape)a.globalAlpha=this.alpha,this.drawAngle!==0?(a.translate(c,d),a.rotate(i),a.drawImage(this.resource.source,this.startX,this.startY,g,h,b.x/2,b.y/2,g-b.x,h-b.y)):a.drawImage(this.resource.source,this.startX,this.startY,g,h,c-e,d-f,g-b.x,h-b.y);else{var j=this.color||{r:0,g:0,b:0};a.fillStyle="rgba("+j.r+","+j.g+","+j.b+","+this.alpha+")",this.drawAngle!==0?(a.translate(c,d),a.rotate(i),a.fillRect(-e,-f,g-b.x,h-b.y)):a.fillRect(c-e,d-f,g-b.x,h-b.y)}a.restore(),a.globalCompositeOperation="source-over"},Jest.Particle.prototype.colorFade=function(a,c,d,e){var f=e/d,h=c.r+f*(a.r-c.r);return b=c.b+f*(a.b-c.b),g=c.g+f*(a.g-c.g),{r:Math.floor(Math.min(255,Math.max(0,h))),g:Math.floor(Math.min(255,Math.max(0,g))),b:Math.floor(Math.min(255,Math.max(0,b)))}},function(){function a(a){a=a||{},this.state=a.state||Game.currentState,this.width=a.width||Game.bounds.width,this.height=a.height||Game.bounds.height,this.items=[],Game.addEntity(this,!0,this.state)}this.UI=a,a.prototype={addItem:function(a,b){b===undefined&&(b=1),a.ui=!0,a.uiIndex=b,Game.addEntity(a,!1,this.state),this.items.push(a)},hide:function(){var a=this.items.length;while(a--)this.items[a].visible=!1},show:function(){var a=this.items.length;while(a--)this.items[a].visible=!0},update:function(a){},render:function(a){}}}(),Button.prototype=new Jest.Sprite,Button.prototype.clicked=function(){Sprite.prototype.clicked(),this.clicked&&this.clicked()},Button.prototype.mouseover=function(a){this.hover&&this.hover(a)},Button.prototype.update=function(a){Jest.Sprite.prototype.update();var b=this.pos.x-this.origin.x,c=this.pos.y-this.origin.y;Game.mouseX>b&&Game.mouseX<b+this.width&&Game.mouseY>c&&Game.mouseY<c+this.height?this.mouseover(!0):this.mouseover(!1)},Cursor.prototype=new Jest.Sprite,Cursor.prototype.update=function(a){Jest.Sprite.prototype.update(),this.pos.x=Game.mouseX,this.pos.y=Game.mouseY},Jest.ParralaxBackground=function(a){this.live=!0,this.curSpeedCheck=0,this.curSpeedMult=0,this.backgrounds=[],a=a||{},this.width=a.width||Game.bounds.width,this.height=a.height||Game.bounds.height,this.state={id:0},"state"in a&&(this.state=a.state),Game.addEntity(this,!0,this.state)},Jest.ParralaxBackground.prototype.addBackground=function(a){if(!a)return!1;var b={},c=0,d=0;if(!a.background)return!1;b=a.background,Game.addEntity(b,!1,this.state),a.speedMultX&&(c=a.speedMultX),a.speedMultY&&(d=a.speedMultY),this.backgrounds.push({bg:b,speedMultX:c,speedMultY:d})},Jest.ParralaxBackground.prototype.updateBackground=function(a){typeof a!="undefined"&&typeof a.bgIndex!="undefined"&&(a.speedMultX&&(this.backgrounds[a.bgIndex].speedMultX=a.speedMultX),a.speedMultY&&(this.backgrounds[a.bgIndex].speedMultY=a.speedMultY))},Jest.ParralaxBackground.prototype.update=function(a){for(var b=this.backgrounds.length,c=0;c<b;c++)this.backgrounds[c].bg.scroll(this.backgrounds[c].speedMultX,this.backgrounds[c].speedMultY,a)},Jest.Background=function(a){a=a||{},this.resource=a.resource||null,this.width=a.width||Jest.bounds.width,this.height=a.height||Jest.bounds.height,this.startX=a.startX||0,this.startY=a.startY||0;var b=32,c=32;this.resource&&(b=this.resource.source.width),this.resource&&(c=this.resource.source.height),this.endX=a.endX||b,this.endY=a.endY||c,this.bgIndex=a.bgIndex||0,this.pos={x:a.x||0,y:a.y||0},this.state=a.state||{id:0},this.visible=!0,this.x=this.pos.x,this.y=this.pos.y,this.scrollX=0,this.scrollY=0,this.live=!0,this.bg=!0;if(this.endX<this.width){var d=document.createElement("canvas"),e=d.getContext("2d"),f=this.resource.source,g=this.width-this.endX;d.width=this.endX+g,d.height=this.endY,e.drawImage(f,0,0,this.endX,this.endY,0,0,this.endX,this.endY),e.drawImage(f,0,0,g,this.endY,this.endX,0,g,this.endY),this.endX=this.endX+g,this.resource.source=d}},Jest.Background.prototype={update:function(a){},scroll:function(a,b,c){this.scrollX+=a*c,this.scrollY+=b*c,this.scrollY>this.endY?this.scrollY=0:this.scrollY<0&&(this.scrollY=this.endY),this.scrollX>this.endX?this.scrollX=0:this.scrollX<0&&(this.scrollX=this.endX)},render:function(a){a.save();var b=this.resource.source;if(this.startY+this.scrollY>this.endY-this.height||this.startX+this.scrollX>this.endX-this.width){var c=[this.startX+this.scrollX,this.startX],d=[this.startY+this.scrollY,this.startY],e=[this.width,this.width],f=[this.height,this.height],g=[this.pos.x,this.pos.x],h=[this.pos.y,this.pos.y],i=[this.width,this.width],j=[this.height,this.height];this.startY+this.scrollY>this.endY-this.height&&(d[0]=this.startY+this.scrollY,d[1]=this.startY,f[0]=this.endY-(this.startY+this.scrollY),f[1]=this.height,h[0]=this.pos.y,h[1]=this.pos.y+this.endY-(this.startY+this.scrollY),j[0]=this.endY-(this.startY+this.scrollY),j[1]=this.height),this.startX+this.scrollX>this.endX-this.width&&(c[0]=this.startX+this.scrollX,c[1]=this.startX,e[0]=this.endX-(this.startX+this.scrollX),e[1]=this.width,g[0]=this.pos.x,g[1]=this.pos.x+this.endX-(this.startX+this.scrollX),i[0]=this.endX-(this.startX+this.scrollX),i[1]=this.width),a.drawImage(b,c[0],d[0],e[0],f[0],g[0],h[0],i[0],j[0]),a.drawImage(b,c[1],d[1],e[1],f[1],g[1],h[1],i[1],j[1])}else a.drawImage(b,this.startX+this.scrollX,this.startY+this.scrollY,this.width,this.height,this.pos.x,this.pos.y,this.width,this.height);a.restore()}},Jest.Transition=function(a,b){b?this.callback=b:this.callback=function(){return!0},this.effect="fadeOut",this.duration=1e3,this.start=(new Date).getTime(),a!==undefined&&(a.effect&&(this.effect=a.effect),a.duration&&(this.duration=a.duration)),this.timeStep=this.duration/Game.frameRate,this.steps=this.duration/Game.frameRate,this.curStep=0,this.visible=!0,this.live=!0,Game.addEntity(this)},Jest.Transition.prototype={update:function(a){this.complete&&(this.live=!1,this.callback())},render:function(a){switch(this.effect){case"fadeOut":a.globalAlpha=1-1/this.timeStep*this.curStep;break;case"fadeIn":a.globalAlpha=1/this.timeStep*this.curStep}this.curStep++,this.curStep>=this.steps&&(this.complete=!0)}}